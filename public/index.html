<!DOCTYPE html>
<html>

<head>
  <title>Playlist Sorting for Spotify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/default.css">
</head>

<body>
  <div class="header">
    <h1>Playlist Sorting for Spotify</h1>
    <hr/>
    <div id="app-description">
      Sort your Spotify playlists online
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div id="login">
        <a href="#" class="btn btn-primary btn-login" id="login-href">Log in with Spotify</a>
      </div>
      <div id="loggedin">
        <div id="user-info-container">
          <div id="user-profile">
          </div>
          <!--
          <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
          -->
        </div>
        <div id="playlist-container">
          <!--
          <button class="btn btn-default" id="get-user-playlists">Get Playlists</button>
          -->
          <div id="user-playlists">
          </div>
        </div>
        <div id="user-current-playlist-container">
          <div id="user-current-playlist"></div>
          <button class="btn btn-default" id="upload-changed-playlist">Upload Changed Playlist</button>
          <div id="upload-status"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
    <hr/>
    <div>
      Made by Gyuri Ordody &copy; 2017 Â· Check out the
      <a href="https://github.com/gordody/spotify-playlist-shuffle" target="_blank">code on GitHub
        <img src="img/GitHub-Mark-32px.png" height="16" width="16">
      </a>
    </div>
  </div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.10/handlebars.runtime.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sortablejs@1.6.1/Sortable.min.js"></script>
  <script src="libs/spotify-web-api/0.22.1/spotify-web-api.js"></script>
  <script src="libs/just-handlebars-helpers/1.0.13/h.min.js"></script>
  <script src="handlebars_out/templates.js"></script>
  <script>
    (function () {
      // Register helpers for Handlebars
      H.registerHelpers(Handlebars);

      // http://localhost:8888//spotify_playlist_shuffle//login
      function getLocationRoot() {
        var loc = window.location;
        return loc.protocol + '//' + loc.hostname + ':' + loc.port + loc.pathname;
      }

      /*
      $(document).ready(function() {

      });

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      var userProfileTemplate = Handlebars.templates.user_profile_template;
      var userProfilePlaceholder = document.getElementById('user-profile');

      var userPlaylistsTemplate = Handlebars.templates.user_playlist_template;
      var userPlaylistsPlaceholder = document.getElementById('user-playlists');

      var userCurrentPlaylistTemplate = Handlebars.templates.user_current_playlist_template;
      var userCurrentPlaylistPlaceholder = document.getElementById('user-current-playlist');

      var userProfile;
      var userPlaylists;
      var userCurrentPlaylist;
      var sortablePlaylist;

      var params = getHashParams();

      var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;

      var spotifyApi = new SpotifyWebApi();
      spotifyApi.setAccessToken(access_token);

      if (error) {
        alert('There was an error during the authentication');
      } else {
        $('#login-href').attr('href', getLocationRoot() + 'login');
        if (access_token) {
          // render oauth info
          console.log('Tokens found in url', {
            access_token: access_token,
            refresh_token: refresh_token
          });

          spotifyApi.getMe().then(data => {
            userProfilePlaceholder.innerHTML = userProfileTemplate(data);
            userProfile = data;
            $('#login').hide();
            $('#loggedin').show();

            getUserPlaylists();
          }).catch(err => {
            $('#login').show();
          });
        } else {
          // render initial screen
          $('#login').show();
          $('#loggedin').hide();
        }

        var obtainNewToken = function () {
          $.ajax({
            url: getLocationRoot() + 'refresh_token',
            data: {
              'refresh_token': refresh_token
            }
          }).done(function (data) {
            access_token = data.access_token;
            spotifyApi.setAccessToken(access_token);
            console.log('New tokens obtained', {
              access_token: access_token,
              refresh_token: refresh_token
            });
          });
        };

        var getUserPlaylists = function () {
          spotifyApi.getUserPlaylists().then(data => {
            userPlaylistsPlaceholder.innerHTML = userPlaylistsTemplate(data);
            userPlaylists = data;
            setupPlaylistLoader();
          });
        };

        var getUserPlaylist = function (userId, playlistId) {
          spotifyApi.getPlaylist(userId, playlistId).then(data => {
            userCurrentPlaylistPlaceholder.innerHTML = userCurrentPlaylistTemplate(data);
            userCurrentPlaylist = data;
            var trackListElem = document.getElementById('track-list');
            sortablePlaylist = Sortable.create(trackListElem, {
              // handle: '.drag-handle',
              animation: 150,
              // delay: 100,
              chosenClass: 'chosen-track-item',
              // ghostClass: 'ghost-track-item',
              filter: '.remove-button',
              onFilter: function(evt) {
		          	evt.item.parentNode.removeChild(evt.item);
		          }
            });
            setupUploadPlaylistHandler();
            $('#user-current-playlist-container').show();   // TODO(go) only show if something changed
          });
        };

        var uploadPlaylist = function () {
          var user_id = userProfile.id;
          var playlist_id = userCurrentPlaylist.id;
          var newTrackIdOrder = sortablePlaylist.toArray();

          $('#upload-status').show();
          $('#upload-status').text('Starting upload');
          spotifyApi.replaceTracksInPlaylist(user_id, playlist_id, newTrackIdOrder).then(data => {
            console.log('Tracks updated');
            $('#upload-status').text('Upload finished');
          }).catch(err => {
            console.log('Tracks update failed', err);
            $('#upload-status').text('Upload failed: ' + err);
          });
        }

        $('#obtain-new-token').on('click', obtainNewToken, false);
        $('#get-user-playlists').on('click', getUserPlaylists);

        function setupPlaylistLoader() {
          $('#user-playlists').on('click', function (e) {
            var target = e.target;
            if (target.hasAttribute('data-playlist-id')) {
              var userId = userProfile.id;
              var playlistId = $('#' + target.id).data('playlist-id');
              getUserPlaylist(userId, playlistId);
            }
            e.stopPropagation();
          });
        }

        function setupUploadPlaylistHandler() {
          $('#upload-changed-playlist').on('click', uploadPlaylist);
        }

      }
    })();
  </script>
</body>

</html>